@startuml
title SAGA – Compensación por Error (Parte 2 de 2)
autonumber

participant "StateMachine"             as SM
participant "SagaResilienceAspect"      as Aspect
participant "SagaOrchestratorService"   as Orquestador
participant "EmpleadoSagaActions"       as EmpleadoActions
participant "servicio-empleado"         as EmpleadoClient

'--- Rollback final: revertir alta de empleado ---
Orquestador -> SM : sendEvent(REVERTIR_ALTA)
activate SM
SM -> Aspect : intercept(doRevertirEmpleado)
activate Aspect

'--- Aspecto invoca la acción de revertir empleado ---
Aspect -> EmpleadoActions : doRevertirEmpleado(context)
activate EmpleadoActions

'--- EmpleadoSagaActions llama al microservicio Empleado ---
EmpleadoActions -> EmpleadoClient : anulaRegistro(empleadoId)
EmpleadoClient --> EmpleadoActions : Alta revertida

'--- Retorno al aspecto ---
EmpleadoActions --> Aspect : success
deactivate EmpleadoActions

'--- Aspect retorna al StateMachine ---
Aspect --> SM : return
deactivate Aspect

SM -> Orquestador : (ack)
Orquestador -> SM : sendEvent(ERROR)
activate SM

SM -> SM : transición a ESTADO_FALLIDO

deactivate SM

@enduml
