@startuml
title Fallback – Servicio Entrenamiento
autonumber

actor Cliente
participant "API Gateway"    as Gateway
participant "SagaController"  as Controller
participant "StateMachine"    as SM
participant "EntrenamientoSagaActions" as EntrenamientoActions
participant "EntrenamientoClient" as EntrenamientoClient
participant "EntrenamientoClientFallback" as EntrenamientoFallback
participant "DomainEventPublisher" as Publisher

'--- 1) Cliente invoca operación de asignar/actualizar/cancelar entrenamiento ---
Cliente -> Gateway : POST /api/saga/entrenamientos\n{entrenamientoDto}
Gateway -> Controller : createOrUpdateOrCancelTraining(entDto)

'--- 2) Controller arranca la saga ---
Controller -> SM : startReactively()
activate SM
SM -> Controller : Mono<Void> (ack)

Controller -> SM : sendEvent(Mono.just(ASIGNAR_ENTRENAMIENTO))
activate SM

'--- 3) StateMachine ejecuta la acción doAsignarEntrenamiento() ---
SM -> EntrenamientoActions : doAsignarEntrenamiento(context)
activate EntrenamientoActions

'--- 4) EntrenamientoActions llama al microservicio-Entrenamiento (simulación de fallo) ---
EntrenamientoActions -> EntrenamientoClient : asignarEntrenamiento(entDto)
EntrenamientoClient --> EntrenamientoActions : (exception o timeout)

'--- 5) Debido al error o circuit breaker, se dispara el fallback ---
EntrenamientoActions -> EntrenamientoFallback : fallbackAsignarEntrenamiento(entDto)
activate EntrenamientoFallback

'--- 6) El fallback publica un evento en Kafka indicando fallo ---
EntrenamientoFallback -> Publisher : publish("servicio-entrenamiento.fallback.assign", entDto)
activate Publisher
Publisher --> EntrenamientoFallback : ack

'--- 7) El fallback notifica error al StateMachine ---
EntrenamientoFallback -> SM : sendEvent(Mono.just(ERROR))
deactivate EntrenamientoFallback
deactivate Publisher

'--- 8) StateMachine recibe ERROR y transita a FALLIDO ---
SM -> SM : transición a estado FALLIDO\n(onErrorAction)

deactivate EntrenamientoActions
deactivate SM

'--- 9) Controller devuelve error al cliente ---
Controller --> Gateway : HTTP 500 Internal Server Error
Gateway --> Cliente   : {error: "Circuit breaker abierto"}


@enduml
