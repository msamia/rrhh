= Microservicios de RRHH

Este repositorio contiene varios servicios de Spring Boot que conforman el sistema de recursos humanos.

== Requisitos previos

* Debés tener instalado JDK 17 y disponible en tu `PATH`.
* MariaDB tiene que estar corriendo de forma local para los perfiles de desarrollo y producción. Creá las bases de datos llamadas `contrato`, `empleado`, `entrenamiento`, `nomina`, `consultas` y `orquestador`.
* Docker y Docker Compose para la infraestructura opcional (Kafka y Zookeeper). Se provee un archivo `compose.yaml`.
* Las pruebas usan la base H2 en memoria, así que no necesitás configuración adicional.

=== Configurar Maven Wrapper

Por políticas de GitHub se omitió el archivo binario `maven-wrapper.jar`.
Descargá la versión 3.3.2 desde Maven Central o de un commit previo y copiála
en `.mvn/wrapper/` dentro de la raíz del repositorio. Luego duplicá el mismo
`jar` en la carpeta `.mvn/wrapper/` de cada módulo para poder ejecutar `./mvnw`
sin conexión a Internet.

== Compilación y ejecución de los servicios

Cada módulo de servicio incluye su propio script de Maven Wrapper. Navegá al módulo deseado y ejecutá:

[source,bash]
----
./mvnw spring-boot:run
----

Los módulos disponibles son (cada uno incluye su propio `README.adoc`):

* link:comunes/README.adoc[comunes]
* link:servicio-contrato/README.adoc[servicio-contrato]
* link:servicio-empleado/README.adoc[servicio-empleado]
* link:servicio-entrenamiento/README.adoc[servicio-entrenamiento]
* link:servicio-nomina/README.adoc[servicio-nomina]
* link:servicio-orquestador/README.adoc[servicio-orquestador]
* link:servicio-consultas/README.adoc[servicio-consultas]
* link:API-gateway/README.adoc[API-gateway]
* link:servidor-para-descubrimiento/README.adoc[servidor-para-descubrimiento]

== Propiedades del proyecto

El `pom.xml` principal define varias versiones compartidas para los módulos. Las
más relevantes son:

* `java.version` -> 17
* `spring-cloud.version` -> 2025.0.0
* `require.maven.version` -> 3.9.9
* `actuator.version` -> 3.4.5

Desde la raíz del repositorio podés compilar todos los módulos a la vez:

[source,bash]
----
./mvnw clean package
----

== Ejecución de pruebas

Ejecutá las pruebas de todos los módulos con:

[source,bash]
----
./mvnw test
----

o dentro de un módulo en particular:

[source,bash]
----
cd servicio-contrato
./mvnw test
----

== Docker Compose

Se incluye una configuración mínima de Docker Compose para levantar Kafka y Zookeeper que requieren los servicios:

[source,bash]
----
docker compose up -d
----

Asegurate de que tu instancia local de MariaDB esté corriendo con esas bases de datos creadas antes de iniciar los servicios. Las pruebas usarán H2 automáticamente.

== Postman Tests

En `docs/postman` se incluyen colecciones de Postman de ejemplo. Importá `rrhh-saga-tests.postman_collection.json` en Postman para probar los flujos de creación, actualización, eliminación y estado de la SAGA mediante los endpoints `/api/saga/empleado-contrato`. El archivo `consultas-saga-tests.postman_collection.json` contiene solicitudes adicionales que validan cómo `servicio-consultas` se actualiza luego de cada operación POST, PUT y DELETE. La respuesta del POST inicial guarda los identificadores de empleado y contrato generados en las variables de colección `{{empleadoId}}` y `{{contratoId}}` para que los siguientes pedidos las reutilicen automáticamente.

Para eliminaciones, pasá tanto el id de empleado como el `contratoId` como parámetro de consulta, por ejemplo `DELETE /api/saga/empleado-contrato/5?contratoId=10`.
Usá `GET /api/saga/empleado-contrato/{sagaId}` para inspeccionar el estado de una saga.

Para verificar si se abre el circuit breaker de creación de empleado, hacé varios pedidos fallidos (por ejemplo deteniendo `servicio-empleado`) y luego enviá un `GET` a `http://localhost:8095/actuator/cb-state/crearEmpleadoCB?includeState=true`.
El controlador `CircuitBreakerStatusController` expone de forma explícita el estado de cada breaker en esa URL `/actuator/cb-state/{name}`.

La solicitud `Estado Circuit Breaker crearEmpleadoCB` de la colección de Postman espera que el estado del breaker sea `OPEN`.

Para auditar los intentos de creación de empleado, consultá `GET http://localhost:8095/actuator/cb-state/empleado-actions`.
